<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConvoSpace</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, set, push, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzfN_BtTw0JMgkn9D5apkrH9h4QV0jwY0",
            authDomain: "convospace-e4d4f.firebaseapp.com",
            databaseURL: "https://convospace-e4d4f-default-rtdb.firebaseio.com",
            projectId: "convospace-e4d4f",
            storageBucket: "convospace-e4d4f.appspot.com",
            messagingSenderId: "239356822811",
            appId: "1:239356822811:web:33db35f2243c2161f03fbe",
            measurementId: "G-TMWZSHDBQL"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // UI Elements
        const authSection = document.getElementById('auth-section');
        const userInfoSection = document.getElementById('user-info');
        const usernameInput = document.getElementById('username-input');
        const registerButton = document.getElementById('register-button');
        const loginButton = document.getElementById('login-button');
        const loginAnonymousButton = document.getElementById('login-anonymous');
        const logoutButton = document.getElementById('logout');
        const communityNameInput = document.getElementById('community-name');
        const createCommunityButton = document.getElementById('create-community');
        const communitiesList = document.getElementById('communities-list');
        const currentCommunityName = document.getElementById('current-community-name');
        const postInput = document.getElementById('post-input');
        const postImageInput = document.getElementById('post-image');
        const postButton = document.getElementById('post-button');
        const postsList = document.getElementById('posts-list');
        const communityPostSection = document.getElementById('community-post-section');
        const userNameSpan = document.getElementById('user-name');

        // Authentication listeners
        auth.onAuthStateChanged((user) => {
            if (user) {
                const username = usernameInput.value || "Anonymous User";
                showUserInfo(user, username);
            } else {
                showAuthSection();
            }
        });

        // Show user info
        function showUserInfo(user, username) {
            authSection.classList.add("hidden");
            userInfoSection.classList.remove("hidden");
            userNameSpan.textContent = username;
            fetchCommunities();  // Fetch communities when user is authenticated
        }

        // Show authentication section
        function showAuthSection() {
            authSection.classList.remove("hidden");
            userInfoSection.classList.add("hidden");
        }

        // Register a new user with email and password
        registerButton.addEventListener('click', () => {
            const email = prompt("Enter your email:");
            const password = prompt("Enter your password:");
            const username = usernameInput.value.trim();
            if (email && password && username) {
                createUserWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        set(ref(db, 'users/' + userCredential.user.uid), {
                            username: username
                        });
                        showUserInfo(userCredential.user, username);
                    })
                    .catch((error) => {
                        console.error("Error registering user:", error);
                    });
            }
        });

        // Login with email and password
        loginButton.addEventListener('click', () => {
            const email = prompt("Enter your email:");
            const password = prompt("Enter your password:");
            if (email && password) {
                signInWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        showUserInfo(userCredential.user, usernameInput.value);
                    })
                    .catch((error) => {
                        console.error("Error logging in:", error);
                    });
            }
        });

        // Login anonymously
        loginAnonymousButton.addEventListener('click', () => {
            signInAnonymously(auth).then((userCredential) => {
                showUserInfo(userCredential.user, "Anonymous User");
            }).catch((error) => {
                console.error("Error logging in anonymously:", error);
            });
        });

        // Logout
        logoutButton.addEventListener('click', () => {
            signOut(auth).then(() => {
                showAuthSection();
            }).catch((error) => {
                console.error("Error logging out:", error);
            });
        });

        // Create a community
        createCommunityButton.addEventListener('click', () => {
            const communityName = communityNameInput.value.trim();
            if (communityName) {
                set(ref(db, 'communities/' + communityName), {
                    name: communityName
                }).then(() => {
                    communityNameInput.value = '';
                    fetchCommunities();  // Refresh the community list
                }).catch((error) => {
                    console.error("Error creating community:", error);
                });
            }
        });

        // Fetch communities from the database
        function fetchCommunities() {
            get(ref(db, 'communities/')).then((snapshot) => {
                communitiesList.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const community = childSnapshot.val();
                    const communityDiv = document.createElement('div');
                    communityDiv.textContent = community.name;
                    communityDiv.className = "community";
                    // Join community on click
                    communityDiv.addEventListener('click', () => {
                        joinCommunity(community.name);
                    });
                    communitiesList.appendChild(communityDiv);
                });
            }).catch((error) => {
                console.error("Error fetching communities:", error);
            });
        }

        // Join a community and fetch posts
        function joinCommunity(name) {
            currentCommunityName.textContent = name;
            communityPostSection.classList.remove("hidden");
            fetchPosts(name);
        }

        // Fetch posts from the selected community
        function fetchPosts(communityName) {
            get(ref(db, 'posts/' + communityName)).then((snapshot) => {
                postsList.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const post = childSnapshot.val();
                    const postId = childSnapshot.key;

                    const postElement = document.createElement('div');
                    postElement.className = 'post';
                    const textElement = document.createElement('p');
                    const userElement = document.createElement('span');
                    const commentsList = document.createElement('div');
                    const commentInput = document.createElement('input');
                    const commentButton = document.createElement('button');

                    textElement.innerHTML = formatPostContent(post.content);
                    userElement.textContent = `Posted by: ${post.username}`;
                    commentInput.placeholder = 'Add a comment...';
                    commentButton.textContent = 'Comment';

                    // Comment functionality
                    commentButton.addEventListener('click', () => {
                        const comment = commentInput.value.trim();
                        if (comment) {
                            // Create a new comment under the specific post
                            const commentRef = ref(db, 'comments/' + postId);
                            const newCommentRef = push(commentRef);  // Use push to generate a unique key
                            set(newCommentRef, {
                                content: comment,
                                username: post.username
                            }).then(() => {
                                commentInput.value = '';
                                fetchComments(postId, commentsList);  // Refresh comments
                            });
                        }
                    });

                    fetchComments(postId, commentsList);  // Fetch comments for the post

                    postElement.appendChild(textElement);
                    postElement.appendChild(userElement);
                    postElement.appendChild(commentInput);
                    postElement.appendChild(commentButton);
                    postElement.appendChild(commentsList);
                    postsList.appendChild(postElement);
                });
            }).catch((error) => {
                console.error("Error fetching posts:", error);
            });
        }

        // Fetch comments for a post
        function fetchComments(postId, commentsList) {
            get(ref(db, 'comments/' + postId)).then((snapshot) => {
                commentsList.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const comment = childSnapshot.val();
                    const commentElement = document.createElement('div');
                    commentElement.textContent = `${comment.username}: ${comment.content}`;
                    commentsList.appendChild(commentElement);
                });
            }).catch((error) => {
                console.error("Error fetching comments:", error);
            });
        }

        // Post content in the selected community
        postButton.addEventListener('click', () => {
            const content = postInput.value.trim();
            const communityName = currentCommunityName.textContent;
            const username = userNameSpan.textContent;

            if (content && communityName) {
                const postRef = ref(db, 'posts/' + communityName);
                const newPostRef = push(postRef);  // Use push to generate a unique key for each post
                const imageUrl = postImageInput.files[0] ? URL.createObjectURL(postImageInput.files[0]) : '';

                // Set the new post in the database
                set(newPostRef, {
                    content: content,
                    username: username,
                    imageUrl: imageUrl
                }).then(() => {
                    postInput.value = '';
                    postImageInput.value = '';
                    fetchPosts(communityName);  // Refresh posts
                }).catch((error) => {
                    console.error("Error posting content:", error);
                });
            }
        });

        // Format post content for display
        function formatPostContent(content) {
            const hashtags = content.match(/#[\w]+/g);
            let formattedContent = content;

            if (hashtags) {
                hashtags.forEach((hashtag) => {
                    formattedContent = formattedContent.replace(hashtag, `<a href="#">${hashtag}</a>`);
                });
            }
            return formattedContent;
        }

        // Check if user is verified (placeholder logic)
        function isUserVerified(username) {
            return username === 'verifiedUser';
        }
    </script>
</head>
<body>
    <div id="auth-section">
        <h1>Welcome to ConvoSpace</h1>
        <label for="username-input">Choose a username:</label>
        <input type="text" id="username-input" placeholder="Enter username">
        <button id="register-button">Register</button>
        <button id="login-button">Login</button>
        <button id="login-anonymous">Login Anonymously</button>
    </div>

    <div id="user-info" class="hidden">
        <h2>Hello, <span id="user-name"></span>!</h2>
        <button id="logout">Logout</button>

        <h3>Create a Community</h3>
        <input type="text" id="community-name" placeholder="Community Name">
        <button id="create-community">Create</button>

        <h3>Communities</h3>
        <div id="communities-list"></div>

        <h3 id="current-community-name"></h3>
        <div id="community-post-section" class="hidden">
            <h3>Post in Community</h3>
            <textarea id="post-input" placeholder="What's on your mind?"></textarea>
            <input type="file" id="post-image" accept="image/*">
            <button id="post-button">Post</button>
            <h3>Posts</h3>
            <div id="posts-list"></div>
        </div>
    </div>
</body>

